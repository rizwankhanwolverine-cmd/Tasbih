<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <style>
        body { background: #050508; color: #C2B280; font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        .controls { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.6; font-weight: 700; margin-left: 2px; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        select, input { background: #121216; color: white; border: 1px solid rgba(194,178,128,0.2); padding: 12px; border-radius: 10px; font-size: 0.85rem; width: 100%; box-sizing: border-box; }
        
        .hifz-settings { display: none; background: rgba(194,178,128,0.05); padding: 15px; border-radius: 15px; margin-top: 5px; border: 1px dashed rgba(194,178,128,0.3); }
        .hifz-active .hifz-settings { display: block; }

        .q-card { width: 100%; max-width: 400px; background: rgba(194,178,128,0.05); border: 1px solid rgba(194,178,128,0.15); border-radius: 25px; padding: 30px; min-height: 250px; display: flex; flex-direction: column; justify-content: center; position: relative; cursor: pointer; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .ara { font-family: 'Amiri', serif; font-size: 1.8rem; color: white; direction: rtl; line-height: 2.2; transition: 0.4s ease; }
        
        /* Hifz Obscure Logic */
        .hifz-active .ara { background: #C2B280; color: #C2B280; border-radius: 8px; filter: blur(2px); }
        .hifz-active .ara.revealed { background: transparent; color: white; filter: blur(0); }
        
        .tra { margin-top: 20px; font-size: 0.9rem; opacity: 0.7; color: #CCC; line-height: 1.5; }
        .hifz-btn { background: none; border: 1px solid #C2B280; color: #C2B280; border-radius: 10px; font-size: 0.7rem; font-weight: 800; cursor: pointer; padding: 10px; height: 100%; }
        .apply-btn { background: #C2B280; color: #050508; border: none; padding: 12px; border-radius: 10px; font-weight: 800; cursor: pointer; width: 100%; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body id="main-body">

    <div class="controls">
        <div class="row">
            <div class="filter-group">
                <span class="filter-label">Select Surah</span>
                <select id="s-surah" onchange="changeSurah()"></select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Study Mode</span>
                <button id="hifz-toggle" class="hifz-btn" onclick="toggleHifz()">HIFZ: OFF</button>
            </div>
        </div>

        <div class="hifz-settings">
            <div class="row">
                <div class="filter-group">
                    <span class="filter-label">From Verse</span>
                    <input type="number" id="hifz-from" value="1" min="1">
                </div>
                <div class="filter-group">
                    <span class="filter-label">To Verse</span>
                    <input type="number" id="hifz-to" value="6" min="1">
                </div>
            </div>
            <button class="apply-btn" onclick="applyHifzRange()">Apply Loop Range</button>
        </div>
        
        <div class="filter-group">
            <span class="filter-label">Translation Language</span>
            <select id="s-lang" onchange="fetchVerse()">
                <option value="none">No Translation</option>
                <option value="en.sahih">English (Sahih Intl)</option>
                <option value="ur.ahmedali">Urdu (Ahmed Ali)</option>
                <option value="fr.hamidullah">French (Hamidullah)</option>
            </select>
        </div>
    </div>

    <div class="q-card" onclick="revealText()">
        <div id="q-ara" class="ara">Connecting to Sanctuary...</div>
        <div id="q-tra" class="tra"></div>
    </div>

    <div style="display:flex; gap:40px; margin-top:30px; align-items:center;">
        <button onclick="prev()" style="background:none; border:none; color:#C2B280; font-size:1.8rem; cursor:pointer;">⏮</button>
        <button id="p-btn" onclick="togglePlay()" style="background:#C2B280; color:#050508; width:60px; height:60px; border-radius:50%; font-size:1.5rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 15px rgba(194,178,128,0.3);">▶</button>
        <button onclick="next()" style="background:none; border:none; color:#C2B280; font-size:1.8rem; cursor:pointer;">⏭</button>
    </div>

    <script>
        const RULES = { fatihaCap: 6, bismillah: /^بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ|^بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ/ };
        let surah = 1, verse = 1, playing = false, hifzMode = false, audio = new Audio(), data = [];
        let hifzFrom = 1, hifzTo = 1;

        async function init() {
            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const d = await res.json(); data = d.data;
                const sSel = document.getElementById('s-surah');
                data.forEach(s => { sSel.innerHTML += `<option value="${s.number}">${s.number}. ${s.englishName}</option>`; });
                refresh();
            } catch(e) { document.getElementById('q-ara').textContent = "Offline"; }
        }

        function toggleHifz() {
            hifzMode = !hifzMode;
            document.getElementById('main-body').classList.toggle('hifz-active', hifzMode);
            document.getElementById('hifz-toggle').textContent = hifzMode ? "HIFZ: ON" : "HIFZ: OFF";
            if(!hifzMode) document.getElementById('q-ara').classList.remove('revealed');
        }

        function applyHifzRange() {
            hifzFrom = parseInt(document.getElementById('hifz-from').value);
            hifzTo = parseInt(document.getElementById('hifz-to').value);
            verse = hifzFrom;
            fetchVerse();
        }

        function revealText() {
            if(hifzMode) document.getElementById('q-ara').classList.toggle('revealed');
        }

        function refresh() { fetchVerse(); }

        async function fetchVerse() {
            document.getElementById('q-ara').classList.remove('revealed');
            const lang = document.getElementById('s-lang').value;
            let apiV = (surah == 1) ? parseInt(verse) + 1 : verse;
            let url = `https://api.alquran.cloud/v1/ayah/${surah}:${apiV}/editions/quran-uthmani`;
            if(lang !== "none") url += `,${lang}`;
            
            const res = await fetch(url);
            const d = await res.json();
            let text = d.data[0].text;
            if(verse == 1 && surah != 1 && surah != 9) text = text.replace(RULES.bismillah, "").trim();
            
            document.getElementById('q-ara').textContent = text;
            document.getElementById('q-tra').textContent = (lang !== "none") ? d.data[1].text : "";
            audio.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${d.data[0].number}.mp3`;
            if(playing) audio.play();
            
            audio.onended = () => {
                if(hifzMode && verse >= hifzTo) {
                    verse = hifzFrom;
                } else {
                    let max = (surah == 1) ? RULES.fatihaCap : data[surah-1].numberOfAyahs;
                    if(verse < max) verse++; else { surah++; verse=1; }
                }
                fetchVerse();
            };
        }

        function togglePlay() { 
            playing = !playing; 
            playing ? audio.play() : audio.pause(); 
            document.getElementById('p-btn').textContent = playing ? '⏸' : '▶'; 
        }

        function next() { 
            let max = (surah == 1) ? RULES.fatihaCap : data[surah-1].numberOfAyahs;
            if(verse < max) verse++; else { surah++; verse=1; }
            fetchVerse();
        }

        function prev() { if(verse > 1) { verse--; fetchVerse(); } }

        function changeSurah() { 
            surah = document.getElementById('s-surah').value; 
            verse = 1; 
            document.getElementById('hifz-from').value = 1;
            document.getElementById('hifz-to').value = (surah == 1) ? 6 : data[surah-1].numberOfAyahs;
            refresh(); 
        }

        init();
    </script>
</body>
</html>
