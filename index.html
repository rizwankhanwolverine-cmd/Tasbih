<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050508">
    
    <link rel="manifest" href="manifest.json?v=6">
    <link rel="apple-touch-icon" href="icon.png?v=6">
    <link rel="icon" type="image/png" href="icon.png?v=6">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <title>Sanctuary Infinity</title>
    <style>
        :root { --gold: #C2B280; --vanta: #050508; --white: #FFFFFF; --dark-grey: #121214; }
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }

        body { 
            background-color: var(--vanta); color: var(--gold); 
            font-family: -apple-system, system-ui, sans-serif; 
            margin: 0; padding: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        .page { display: none; flex-direction: column; justify-content: center; align-items: center; height: calc(100vh - 70px); width: 100%; padding: 20px; }
        .active-page { display: flex; }

        /* TASBIH STYLES */
        .stats { font-size: 0.8rem; font-weight: bold; letter-spacing: 2px; color: var(--gold); opacity: 0.7; }
        .tasbih-wrapper { position: relative; width: 260px; height: 260px; display: flex; justify-content: center; align-items: center; margin: 15px 0; }
        .progress-ring { position: absolute; transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.3s; stroke: var(--gold); stroke-linecap: round; }
        .circle { width: 190px; height: 190px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 4.5rem; background: radial-gradient(circle, #1a1a1a 0%, var(--vanta) 100%); box-shadow: inset 0 0 30px #000; }

        /* SALAH STYLES */
        .salah-list { width: 100%; max-width: 320px; }
        .salah-card {
            background: var(--dark-grey); margin: 8px 0; padding: 18px;
            border-radius: 12px; border: 1px solid rgba(194, 178, 128, 0.05);
            display: flex; justify-content: center; align-items: center;
            transition: all 0.5s ease;
        }
        .salah-name { font-size: 1rem; letter-spacing: 4px; text-transform: uppercase; font-weight: 300; color: rgba(194,178,128,0.3); }
        .salah-card.lit { background: rgba(194, 178, 128, 0.12); border: 1px solid var(--gold); box-shadow: 0 0 15px rgba(194, 178, 128, 0.2); }
        .salah-card.lit .salah-name { color: var(--white); text-shadow: 0 0 10px var(--gold); }

        /* HISTORY BAR */
        .history-container { margin-top: 25px; text-align: center; }
        .history-label { font-size: 0.6rem; letter-spacing: 2px; opacity: 0.5; margin-bottom: 8px; }
        .history-dots { display: flex; gap: 8px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(194, 178, 128, 0.2); }
        .dot.complete { background: var(--gold); box-shadow: 0 0 8px var(--gold); border: none; }

        /* NAV */
        .nav-bar { height: 70px; background: #0a0a0d; border-top: 1px solid rgba(194, 178, 128, 0.1); display: flex; justify-content: space-around; align-items: center; }
        .nav-item { color: var(--gold); opacity: 0.3; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; padding: 10px; transition: 0.3s; }
        .nav-item.active { opacity: 1; border-bottom: 2px solid var(--gold); }
    </style>
</head>
<body id="main-body">

    <div id="page-tasbih" class="page active-page" onclick="handleTasbihTap(event)">
        <div class="stats">DAILY: <span id="todayNum">0</span> | SETS: <span id="setNum">0</span></div>
        <h1 style="letter-spacing: 8px; font-weight: 200; margin: 10px 0;">TASBIH</h1>
        <div class="tasbih-wrapper">
            <svg width="260" height="260" class="progress-ring">
                <circle stroke="rgba(194, 178, 128, 0.05)" stroke-width="4" fill="transparent" r="115" cx="130" cy="130"/>
                <circle id="ring" class="progress-ring__circle" stroke-width="6" fill="transparent" r="115" cx="130" cy="130"/>
            </svg>
            <div class="circle"><span id="num">0</span></div>
        </div>
        <button style="background:none; border:1px solid rgba(194,178,128,0.2); color:var(--gold); padding:5px 15px; border-radius:20px; font-size:0.6rem;" onclick="resetSession(event)">Reset Session</button>
    </div>

    <div id="page-salah" class="page">
        <h2 style="font-weight: 200; letter-spacing: 5px; margin-bottom: 10px;">SALAH LOG</h2>
        <div class="salah-list">
            <div class="salah-card" onclick="toggleSalah('fajr')"><span class="salah-name">Fajr</span></div>
            <div class="salah-card" onclick="toggleSalah('dhuhr')"><span class="salah-name">Dhuhr</span></div>
            <div class="salah-card" onclick="toggleSalah('asr')"><span class="salah-name">Asr</span></div>
            <div class="salah-card" onclick="toggleSalah('maghrib')"><span class="salah-name">Maghrib</span></div>
            <div class="salah-card" onclick="toggleSalah('isha')"><span class="salah-name">Isha</span></div>
        </div>
        
        <div class="history-container">
            <div class="history-label">LAST 7 DAYS</div>
            <div class="history-dots" id="history-dots"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div id="nav-tasbih" class="nav-item active" onclick="switchPage('tasbih')">Tasbih</div>
        <div id="nav-salah" class="nav-item" onclick="switchPage('salah')">Salah</div>
    </div>

    <script>
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioCtx();
        function playSnd(f, d) {
            if (audioContext.state === 'suspended') audioContext.resume();
            const o = audioContext.createOscillator(); const g = audioContext.createGain();
            o.frequency.setValueAtTime(f, audioContext.currentTime);
            g.gain.setValueAtTime(0.06, audioContext.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + d);
            o.connect(g); g.connect(audioContext.destination); o.start(); o.stop(audioContext.currentTime + d);
        }

        let sessionCount = parseInt(localStorage.getItem('tasbihSession')) || 0;
        let todayCount = parseInt(localStorage.getItem('tasbihToday')) || 0;
        let salahState = JSON.parse(localStorage.getItem('salahState')) || { fajr: false, dhuhr: false, asr: false, maghrib: false, isha: false };
        let history = JSON.parse(localStorage.getItem('salahHistory')) || [];

        function checkDateReset() {
            const lastDate = localStorage.getItem('lastAccessDate');
            const currentDate = new Date().toDateString();
            if (lastDate && lastDate !== currentDate) {
                const allDone = Object.values(salahState).every(v => v === true);
                history.push(allDone);
                if (history.length > 7) history.shift();
                localStorage.setItem('salahHistory', JSON.stringify(history));
                salahState = { fajr: false, dhuhr: false, asr: false, maghrib: false, isha: false };
                todayCount = 0;
                localStorage.setItem('salahState', JSON.stringify(salahState));
                localStorage.setItem('tasbihToday', 0);
                localStorage.removeItem('celebratedToday');
            }
            localStorage.setItem('lastAccessDate', currentDate);
        }

        // --- FIRECRACKER FUNCTION ---
        function fireCelebrate() {
            var duration = 3 * 1000;
            var end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 3,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: 0.8 },
                    colors: ['#C2B280', '#FFFFFF']
                });
                confetti({
                    particleCount: 3,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: 0.8 },
                    colors: ['#C2B280', '#FFFFFF']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active-page'));
            document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active-page');
            document.getElementById('nav-' + p).classList.add('active');
            playSnd(200, 0.05);
        }

        function updateUI() {
            document.getElementById('num').textContent = sessionCount;
            document.getElementById('todayNum').textContent = todayCount;
            document.getElementById('setNum').textContent = Math.floor(sessionCount / 100);
            const circ = 115 * 2 * Math.PI;
            document.getElementById('ring').style.strokeDasharray = `${circ} ${circ}`;
            let p = sessionCount % 100; if (p === 0 && sessionCount > 0) p = 100;
            document.getElementById('ring').style.strokeDashoffset = circ - (p / 100 * circ);
            
            const cards = document.querySelectorAll('.salah-card');
            const keys = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
            let countLit = 0;
            keys.forEach((k, i) => {
                if (salahState[k]) { cards[i].classList.add('lit'); countLit++; }
                else cards[i].classList.remove('lit');
            });

            // Trigger Firecrackers if 5 are lit
            if (countLit === 5 && !localStorage.getItem('celebratedToday')) {
                fireCelebrate();
                playSnd(880, 0.4);
                if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 300]);
                localStorage.setItem('celebratedToday', 'true');
            }

            const histDiv = document.getElementById('history-dots');
            histDiv.innerHTML = '';
            for(let i=0; i<7; i++) {
                const d = document.createElement('div');
                d.className = 'dot' + (history[i] ? ' complete' : '');
                histDiv.appendChild(d);
            }

            localStorage.setItem('tasbihSession', sessionCount);
            localStorage.setItem('tasbihToday', todayCount);
            localStorage.setItem('salahState', JSON.stringify(salahState));
        }

        function handleTasbihTap(e) {
            if (e.target.tagName === 'BUTTON') return;
            sessionCount++; todayCount++;
            playSnd(sessionCount % 100 === 0 ? 880 : 400, 0.1);
            if (navigator.vibrate) navigator.vibrate(30);
            updateUI();
        }

        function toggleSalah(name) {
            salahState[name] = !salahState[name];
            playSnd(salahState[name] ? 600 : 200, 0.2);
            updateUI();
        }

        function resetSession(e) { e.stopPropagation(); if(confirm("Reset session?")) { sessionCount = 0; updateUI(); } }

        checkDateReset();
        updateUI();
    </script>
</body>
</html>
