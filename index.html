const Tasbih = {
    // Logic: Retrieve the last saved count on initialization, default to 0
    count: parseInt(localStorage.getItem('tasbih_count')) || 0,
    audioInit: false,
    pool: [new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'), new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3')],
    poolIdx: 0,
    finishSfx: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
    
    tap() {
        if(!this.audioInit) {
            this.pool.forEach(s => { s.play(); s.pause(); });
            this.finishSfx.play(); this.finishSfx.pause();
            this.audioInit = true;
        }
        this.count++;
        
        // Save to local storage on every tap
        localStorage.setItem('tasbih_count', this.count);

        if(this.count < 100) {
            let s = this.pool[this.poolIdx]; s.currentTime = 0; s.play().catch(e=>{});
            this.poolIdx = (this.poolIdx + 1) % this.pool.length;
            this.updateUI();
        } else {
            this.finishSfx.currentTime = 0; this.finishSfx.play().catch(e=>{});
            this.updateUI();
            setTimeout(() => {
                if(navigator.vibrate) navigator.vibrate(500);
                this.stars(); 
                this.count = 0; 
                localStorage.setItem('tasbih_count', 0); // Reset storage after celebration
                this.updateUI();
            }, 500);
        }
    },
    reset() { 
        this.count = 0; 
        localStorage.setItem('tasbih_count', 0); 
        this.updateUI(); 
    },
    updateUI() {
        document.getElementById('display-num').textContent = this.count;
        document.getElementById('prog-ring').style.strokeDashoffset = 816 - (this.count/100 * 816);
    }
};

// Initial UI update to show the saved count when the app loads
Tasbih.updateUI();
