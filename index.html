<style>
    /* RECITATION SPECIFIC - Isolated from others */
    .reciter-ui { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
    .hifz-badge { background: var(--gold); color: var(--vanta); padding: 4px 12px; border-radius: 12px; font-size: 0.6rem; font-weight: bold; letter-spacing: 1px; margin-bottom: 10px; display: none; }
    .hifz-active .hifz-badge { display: inline-block; }
    
    .q-box { background: var(--glass); border: 1px solid rgba(194,178,128,0.1); border-radius: 25px; padding: 30px 20px; text-align: center; min-height: 200px; }
    .q-ara { font-family: "Amiri", serif; font-size: 1.8rem; color: var(--white); direction: rtl; line-height: 2; margin-bottom: 15px; }
    .q-tra { font-size: 0.95rem; line-height: 1.6; opacity: 0.8; }
    
    .ctrl-tray { display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 20px; margin-bottom: 10px; }
    select, input { background: #111; color: var(--gold); border: 1px solid rgba(194,178,128,0.2); padding: 8px; border-radius: 10px; font-size: 0.8rem; }
    .play-grid { display: flex; align-items: center; justify-content: center; gap: 30px; margin-top: 10px; }
</style>

<div id="v-recitation" class="view">
    <h1 class="header">Recitation</h1>
    
    <div class="reciter-ui" id="reciter-root">
        <div class="ctrl-tray">
            <div style="display:flex; gap:10px;">
                <select id="s-surah" style="flex:2" onchange="QPlayer.initSurah()"></select>
                <select id="s-lang" style="flex:1" onchange="QPlayer.updateContent()">
                    <option value="ur.jalandhry">Urdu</option>
                    <option value="en.sahih">English</option>
                </select>
            </div>
            
            <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                <label style="font-size:0.6rem; opacity:0.6">HIFZ MODE</label>
                <input type="checkbox" id="h-toggle" onchange="QPlayer.toggleHifz()">
                <div id="h-range" style="display:none; gap:5px; align-items:center;">
                    <input type="number" id="h-from" value="0" style="width:50px" onchange="QPlayer.syncRange()">
                    <span>to</span>
                    <input type="number" id="h-to" value="5" style="width:50px" onchange="QPlayer.syncRange()">
                </div>
            </div>
        </div>

        <center><div class="hifz-badge">LOOP ACTIVE</div></center>
        
        <div class="q-box">
            <div class="q-ara" id="q-ara">...</div>
            <div class="q-tra" id="q-tra">...</div>
            <div id="q-tag" style="margin-top:15px; font-size:0.6rem; opacity:0.3; letter-spacing:2px;">VERSE 0</div>
        </div>

        <div class="play-grid">
            <div onclick="QPlayer.prev()" style="cursor:pointer">⏮</div>
            <div id="q-play" onclick="QPlayer.toggle()" style="width:60px; height:60px; background:var(--gold); color:var(--vanta); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; cursor:pointer;">▶</div>
            <div onclick="QPlayer.next()" style="cursor:pointer">⏭</div>
        </div>
    </div>
</div>

<script>
// TASBIH & SALAH LOGIC REMAINS UNTOUCHED ABOVE THIS LINE...

const QPlayer = {
    isHifz: false,
    isPlaying: false,
    surah: 1,
    ayah: 0, // Verse 0 as first verse
    range: { from: 0, to: 5 },
    audio: new Audio(),

    async init() {
        // Fetch Surah list once
        const res = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await res.json();
        const sel = document.getElementById('s-surah');
        data.data.forEach(s => {
            let o = document.createElement('option');
            o.value = s.number; o.textContent = `${s.number}. ${s.englishName}`;
            sel.appendChild(o);
        });
        this.updateContent();

        // HIFZ LOOP LOGIC
        this.audio.onended = () => {
            if(this.isHifz) {
                if(this.ayah >= this.range.to) this.ayah = this.range.from;
                else this.ayah++;
                this.updateContent(true);
            } else {
                this.next();
            }
        };
    },

    async updateContent(autoPlay = false) {
        const lang = document.getElementById('s-lang').value;
        const apiAyah = this.ayah + 1; // API is 1-indexed
        
        try {
            const res = await fetch(`https://api.alquran.cloud/v1/ayah/${this.surah}:${apiAyah}/editions/quran-uthmani,${lang}`);
            const data = await res.json();
            
            document.getElementById('q-ara').textContent = data.data[0].text;
            document.getElementById('q-tra').textContent = data.data[1].text;
            document.getElementById('q-tag').textContent = `VERSE ${this.ayah}`;
            
            this.audio.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${data.data[0].number}.mp3`;
            if(autoPlay || this.isPlaying) this.audio.play();
        } catch(e) { console.error("Recitation Error"); }
    },

    toggle() {
        if(this.isPlaying) { this.audio.pause(); document.getElementById('q-play').textContent = '▶'; }
        else { this.audio.play(); document.getElementById('q-play').textContent = '⏸'; }
        this.isPlaying = !this.isPlaying;
    },

    toggleHifz() {
        this.isHifz = document.getElementById('h-toggle').checked;
        document.getElementById('h-range').style.display = this.isHifz ? 'flex' : 'none';
        document.getElementById('reciter-root').classList.toggle('hifz-active', this.isHifz);
        if(this.isHifz) { this.ayah = this.range.from; this.updateContent(); }
    },

    syncRange() {
        this.range.from = parseInt(document.getElementById('h-from').value);
        this.range.to = parseInt(document.getElementById('h-to').value);
    },

    initSurah() { this.surah = document.getElementById('s-surah').value; this.ayah = 0; this.updateContent(); },
    next() { this.ayah++; this.updateContent(); },
    prev() { if(this.ayah > 0) { this.ayah--; this.updateContent(); } }
};

// Initialize only Recitation when window loads
const oldLoad = window.onload;
window.onload = () => { if(oldLoad) oldLoad(); QPlayer.init(); };
</script>
