<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sanctuary Infinity</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #C2B280; --vanta: #050508; --white: #FFFFFF; --dark-grey: #121214; }
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }

        body { 
            background-color: var(--vanta); color: var(--gold); 
            font-family: -apple-system, system-ui, sans-serif; 
            margin: 0; padding: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        .page { display: none; flex-direction: column; align-items: center; height: calc(100vh - 85px); width: 100%; padding: 20px; overflow-y: auto; }
        .active-page { display: flex; }

        .header-title { letter-spacing: 5px; font-weight: 200; text-transform: uppercase; margin-bottom: 15px; text-align: center; font-size: 1.1rem; }
        
        .quran-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 12px; }
        .controls-row { display: flex; gap: 8px; width: 100%; }
        .selector { background: var(--dark-grey); color: var(--gold); border: 1px solid rgba(194,178,128,0.2); padding: 10px; border-radius: 10px; flex: 1; font-size: 0.75rem; }
        
        /* HIFZ (MEMORIZATION) PANEL */
        .hifz-panel { 
            background: rgba(194,178,128,0.05); padding: 15px; border-radius: 15px; 
            border: 1px solid rgba(194,178,128,0.1); display: flex; flex-direction: column; gap: 10px;
        }
        .hifz-header { display: flex; justify-content: space-between; align-items: center; }
        .mode-toggle { 
            background: none; border: 1px solid var(--gold); color: var(--gold); 
            padding: 5px 15px; border-radius: 20px; font-size: 0.65rem; letter-spacing: 1px; transition: 0.3s;
        }
        .mode-toggle.active { background: var(--gold); color: var(--vanta); font-weight: bold; }

        .range-inputs { display: flex; align-items: center; gap: 10px; font-size: 0.7rem; opacity: 0.8; }
        .memo-input { background: var(--vanta); border: 1px solid rgba(194,178,128,0.3); color: var(--white); width: 50px; text-align: center; border-radius: 5px; padding: 4px; }

        .reader-frame { 
            background: #0a0a0c; padding: 30px 20px; border-radius: 25px; 
            text-align: center; border: 1px solid rgba(194, 178, 128, 0.1);
            min-height: 320px; display: flex; flex-direction: column; justify-content: center;
        }
        .arabic-text { 
            font-family: 'Amiri', serif; font-size: 2.2rem; line-height: 1.8; 
            color: var(--white); direction: rtl; margin-bottom: 20px;
        }
        .trans-text { font-size: 0.9rem; color: var(--gold); opacity: 0.7; line-height: 1.6; font-style: italic; }

        .audio-controls { display: flex; justify-content: space-around; align-items: center; margin-top: 20px; }
        .ctrl-btn { background: none; border: none; fill: var(--gold); cursor: pointer; width: 40px; height: 40px; }
        .play-pause { width: 60px; height: 60px; background: var(--gold); border-radius: 50%; fill: var(--vanta); display: flex; justify-content: center; align-items: center; }

        .nav-bar { height: 85px; background: #08080a; border-top: 1px solid rgba(194, 178, 128, 0.1); display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

    <div id="page-quran" class="page active-page">
        <h1 class="header-title">The Revelation</h1>
        
        <div class="quran-container">
            <div class="controls-row">
                <select id="surahSelect" class="selector" onchange="initSurah()">
                    <option value="1">1. Al-Fatiha</option>
                    <option value="2">2. Al-Baqarah</option>
                    <option value="112">112. Al-Ikhlas</option>
                    <option value="113">113. Al-Falaq</option>
                    <option value="114">114. Al-Nas</option>
                </select>
                <select id="langSelect" class="selector" onchange="updateVerseUI()">
                    <option value="en">English</option>
                    <option value="ur">Urdu</option>
                </select>
            </div>

            <div class="hifz-panel">
                <div class="hifz-header">
                    <span style="font-size: 0.7rem; letter-spacing: 2px;">HIFZ MODE</span>
                    <button id="hifzBtn" class="mode-toggle" onclick="toggleHifz()">OFF</button>
                </div>
                <div class="range-inputs">
                    <span>From Verse:</span>
                    <input type="number" id="loopFrom" class="memo-input" value="1" onchange="validateLoop()">
                    <span>To:</span>
                    <input type="number" id="loopTo" class="memo-input" value="7" onchange="validateLoop()">
                </div>
            </div>
            
            <div class="reader-frame">
                <div id="v-num" style="font-size: 0.6rem; opacity: 0.4; margin-bottom: 10px; letter-spacing: 2px;">VERSE 1</div>
                <div id="q-arabic" class="arabic-text">...</div>
                <div id="q-trans" class="trans-text">...</div>
                
                <div class="audio-controls">
                    <button class="ctrl-btn" onclick="prevVerse()">
                        <svg viewBox="0 0 24 24"><path d="M6,18L14.5,12L6,6V18M16,6V18H18V6H16Z" transform="rotate(180 12 12)"/></svg>
                    </button>
                    <button id="playBtn" class="play-pause" onclick="toggleAudio()">
                        <svg id="playIcon" viewBox="0 0 24 24" width="30"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>
                    </button>
                    <button class="ctrl-btn" onclick="nextVerse()">
                        <svg viewBox="0 0 24 24"><path d="M6,18L14.5,12L6,6V18M16,6V18H18V6H16Z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <audio id="mainAudio" onended="handleAudioEnd()"></audio>

    <script>
        let currentSurah = 1;
        let currentVerse = 1;
        let totalVerses = 7;
        let verseData = [];
        let isHifzMode = false;
        const audioPlayer = document.getElementById('mainAudio');

        async function initSurah() {
            currentSurah = document.getElementById('surahSelect').value;
            currentVerse = 1;
            pauseAudio();
            
            const [resAr, resEn, resUr] = await Promise.all([
                fetch(`https://api.alquran.cloud/v1/surah/${currentSurah}`),
                fetch(`https://api.alquran.cloud/v1/surah/${currentSurah}/en.sahih`),
                fetch(`https://api.alquran.cloud/v1/surah/${currentSurah}/ur.jalandhry`)
            ]);

            const dataAr = await resAr.json();
            const dataEn = await resEn.json();
            const dataUr = await resUr.json();

            totalVerses = dataAr.data.numberOfAyahs;
            document.getElementById('loopTo').value = totalVerses;
            
            verseData = dataAr.data.ayahs.map((ayah, i) => ({
                ar: ayah.text,
                en: dataEn.data.ayahs[i].text,
                ur: dataUr.data.ayahs[i].text,
                audio: `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${ayah.number}.mp3`
            }));

            updateVerseUI();
        }

        function updateVerseUI() {
            const verse = verseData[currentVerse - 1];
            const lang = document.getElementById('langSelect').value;
            document.getElementById('v-num').textContent = `AYAH ${currentVerse} / ${totalVerses}`;
            document.getElementById('q-arabic').textContent = verse.ar;
            document.getElementById('q-trans').textContent = verse[lang];
            audioPlayer.src = verse.audio;
        }

        function toggleHifz() {
            isHifzMode = !isHifzMode;
            const btn = document.getElementById('hifzBtn');
            btn.textContent = isHifzMode ? "ON" : "OFF";
            btn.classList.toggle('active', isHifzMode);
            
            if (isHifzMode) {
                // Instantly move to the start of the Hifz range
                currentVerse = parseInt(document.getElementById('loopFrom').value);
                updateVerseUI();
            }
        }

        function validateLoop() {
            let from = parseInt(document.getElementById('loopFrom').value);
            let to = parseInt(document.getElementById('loopTo').value);
            if (from < 1) from = 1;
            if (to > totalVerses) to = totalVerses;
            if (from > to) from = to;
            document.getElementById('loopFrom').value = from;
            document.getElementById('loopTo').value = to;
        }

        function handleAudioEnd() {
            const from = parseInt(document.getElementById('loopFrom').value);
            const to = parseInt(document.getElementById('loopTo').value);

            if (isHifzMode) {
                if (currentVerse >= to) {
                    currentVerse = from; // Restart Hifz Loop
                } else {
                    currentVerse++;
                }
                updateVerseUI();
                playAudio();
            } else {
                if (currentVerse < totalVerses) nextVerse();
                else pauseAudio();
            }
        }

        function nextVerse() {
            const to = parseInt(document.getElementById('loopTo').value);
            if (isHifzMode && currentVerse >= to) return; // Prevent going outside hifz range
            if (currentVerse < totalVerses) { currentVerse++; updateVerseUI(); playAudio(); }
        }

        function prevVerse() {
            const from = parseInt(document.getElementById('loopFrom').value);
            if (isHifzMode && currentVerse <= from) return; // Prevent going outside hifz range
            if (currentVerse > 1) { currentVerse--; updateVerseUI(); playAudio(); }
        }

        function toggleAudio() { if (audioPlayer.paused) playAudio(); else pauseAudio(); }
        function playAudio() { audioPlayer.play(); document.getElementById('playIcon').innerHTML = '<path d="M14,19H18V5H14M6,19H10V5H6V19Z"/>'; }
        function pauseAudio() { audioPlayer.pause(); document.getElementById('playIcon').innerHTML = '<path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>'; }

        initSurah();
    </script>
</body>
</html>
