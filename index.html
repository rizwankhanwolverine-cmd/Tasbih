<script>
/* =========================
   STORAGE MODULE
========================= */
const Storage = {
  get(key, fallback = 0) {
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  },
  set(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }
};

/* =========================
   AUDIO MODULE
========================= */
const AudioEngine = {
  unlocked: false,
  tap: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
  done: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),

  unlock() {
    if (this.unlocked) return;
    [this.tap, this.done].forEach(a => {
      a.play().then(() => a.pause()).catch(() => {});
      a.currentTime = 0;
    });
    this.unlocked = true;
    const s = document.getElementById('sound-status');
    if (s) s.style.display = 'none';
  },

  playTap() {
    this.tap.currentTime = 0;
    this.tap.play().catch(() => {});
  },

  playDone() {
    this.done.currentTime = 0;
    this.done.play().catch(() => {});
  }
};

/* =========================
   NAVIGATION MODULE
========================= */
const Navigation = {
  show(id) {
    AudioEngine.unlock();
    document.querySelectorAll('.view, .nav-btn')
      .forEach(e => e.classList.remove('active'));

    document.getElementById(`v-${id}`).classList.add('active');
    document.getElementById(`n-${id}`).classList.add('active');

    if (id === 'journey') {
      document.getElementById('life-val').textContent =
        Storage.get('t_life', 0);
    }
  }
};

/* =========================
   TASBIH MODULE
========================= */
const Tasbih = {
  current: Storage.get('t_cur', 0),
  lifetime: Storage.get('t_life', 0),
  limit: 100,

  hit() {
    AudioEngine.unlock();
    this.current++;
    this.lifetime++;

    if (this.current < this.limit) {
      AudioEngine.playTap();
    } else {
      AudioEngine.playDone();
      setTimeout(() => {
        this.current = 0;
        this.update();
      }, 500);
    }

    Storage.set('t_cur', this.current);
    Storage.set('t_life', this.lifetime);
    this.update();
  },

  reset() {
    this.current = 0;
    Storage.set('t_cur', 0);
    this.update();
  },

  update() {
    document.getElementById('t-num').textContent = this.current;
    document.getElementById('t-ring').style.strokeDashoffset =
      816 - (this.current / this.limit * 816);
  }
};

/* =========================
   SALAH MODULE
========================= */
const Salah = {
  db: Storage.get('s_db_v14', {}),
  selected: new Date().toDateString(),

  init() {
    this.renderDates();
    this.renderGrid();
  },

  renderDates() {
    const sc = document.getElementById('s-dates');
    sc.innerHTML = '';

    for (let i = 0; i < 7; i++) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const ds = d.toDateString();

      const p = document.createElement('div');
      p.className = `pill ${ds === this.selected ? 'active' : ''}`;
      p.textContent = i === 0 ? 'TODAY' : `${d.getDate()} ${d.toLocaleString('default',{month:'short'})}`;

      p.onclick = () => {
        this.selected = ds;
        this.renderDates();
        this.renderGrid();
      };

      sc.appendChild(p);
    }
  },

  renderGrid() {
    const g = document.getElementById('s-grid');
    g.innerHTML = '';
    const day = this.db[this.selected] || {};

    ['Fajr','Dhuhr','Asr','Maghrib','Isha'].forEach(p => {
      const o = document.createElement('div');
      o.className = `orb ${day[p] ? 'lit' : ''}`;
      o.innerHTML = `<span>${p}</span>`;

      o.onclick = () => {
        if (!this.db[this.selected]) this.db[this.selected] = {};
        this.db[this.selected][p] = !this.db[this.selected][p];
        Storage.set('s_db_v14', this.db);
        this.renderGrid();
      };

      g.appendChild(o);
    });
  }
};

/* =========================
   APP BOOTSTRAP
========================= */
const App = {
  init() {
    document.getElementById('life-val').textContent =
      Storage.get('t_life', 0);

    Tasbih.update();
    Salah.init();

    const t = document.getElementById('t-trigger');
    t.addEventListener('touchstart', e => {
      e.preventDefault();
      Tasbih.hit();
    }, { passive: false });

    t.addEventListener('click', e => {
      if (!('ontouchstart' in window)) Tasbih.hit();
    });

    window.addEventListener('touchstart', () => AudioEngine.unlock());
    window.addEventListener('click', () => AudioEngine.unlock());
  }
};

window.onload = App.init;
</script>
